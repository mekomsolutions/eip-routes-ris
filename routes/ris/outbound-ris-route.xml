<routes xmlns="http://camel.apache.org/schema/spring">
    <route id="outbound-ris" errorHandlerRef="deadLetterChannelBuilder">
        <from uri="direct:outbound-ris"/>
        <log message="Processing db event: ${body}" />

        <choice>
            <when>
                <simple>${body.tableName} == 'test_order'</simple>
                <setProperty name="radiology-order-uuid">
                    <simple>${body.identifier}</simple>
                </setProperty>                
                <setBody>
                    <simple>{{openmrs.username}}:{{openmrs.password}}</simple>
                </setBody>
                <marshal>
                    <base64/>
                </marshal>
                <convertBodyTo type="java.lang.String"/>
                
                <setProperty name="basic-openmrs-authentication">
                    <simple>Basic ${body.trim()}</simple>
                </setProperty>

                <setHeader name="Authorization">
                    <simple>${exchangeProperty.basic-openmrs-authentication}</simple>
                </setHeader>

                <setHeader name="CamelHttpMethod">
                    <constant>GET</constant>
                </setHeader>
                
                <!--Retrieving service request from openmrs fhir-->
                
                <to cacheSize="-1" uri="{{openmrs.baseUrl}}/ws/fhir2/R4/ServiceRequest?_id=6b9f82d3-e867-4506-8461-9fb7f65a8869&amp;_include=ServiceRequest:patient&amp;_include=ServiceRequest:requester&amp;_include=ServiceRequest:patient"/>
                <unmarshal>
                    <json library="Jackson"/>
                </unmarshal>
                
                <setProperty name="patient-id">
                    <jsonpath>$.entry[?(@.resource.resourceType =='Patient')].resource.id</jsonpath>
                </setProperty>
                
                <setProperty name="bundle">
                    <jsonpath>$</jsonpath>
                </setProperty>
                
                <setProperty name="bundle-entries">
                    <jsonpath resultType="String">$.entry[?(@.resource)]</jsonpath>
                </setProperty>
                <log message="Processing db event aaaaaaaaaaaaaaaaaaaaaaaaa 2 ${exchangePropertypatient-id}" />
                
                <to cacheSize="-1" uri="{{openmrs.baseUrl}}/ws/fhir2/R4/Patient?_id=e8ccd2de-a238-420d-aebb-ec80d720cdab&amp;_revinclude=Observation:patient&amp;_revinclude=AllergyIntolerance:patient"/>
                <unmarshal>
                    <json library="Jackson"/>
                </unmarshal>
                
                <!-- Filter Patient and allergyIntolerance -->
                <setProperty name="patient-allergyIntolerances">
                    <jsonpath>$.entry[?(@.resource.resourceType in ['AllergyIntolerance'])]</jsonpath>
                </setProperty>
                                
                <!-- Filter weight and height Observation(s) as initial bundle entries -->
                <setProperty name="patient-weight-height">
                    <jsonpath resultType="String">$.entry[?(@.resource.code.coding[0].code in ['5089AAAAAAAAAAAAAAAAAAAAAAAAAAAA','5090AAAAAAAAAAAAAAAAAAAAAAAAAAAA'])]</jsonpath>
                </setProperty>
                
                <!-- Append all the filters to the bundle list -->
                <setProperty name="bundle-entries">
                    <simple>${exchangeProperty.bundle-entries.concat(${exchangeProperty.patient-weight-height})}</simple>
                </setProperty>

                <setProperty name="bundle-entries">
                    <simple>${exchangeProperty.bundle-entries.concat(${exchangeProperty.patient-allergyIntolerances})}</simple>
                </setProperty>

                <setProperty name="bundle-entries">
                    <simple>${exchangeProperty.bundle-entries.replaceAll('\]\[',',')}</simple>
                </setProperty>

                <setBody>
                    <simple>${exchangeProperty.bundle-entries}</simple>
                </setBody>
                
                <unmarshal>
                    <json library="Jackson"/>
                </unmarshal>

                <setProperty name="bundle-entries">
                    <jsonpath>$</jsonpath>
                </setProperty>

                <script>
                    <spel>#{getProperty('bundle').put('entry', getProperty('bundle-entries'))}</spel>
                </script>
                
                <setBody>
                    <simple>${exchangeProperty.bundle}</simple>
                </setBody>

                <marshal>
                    <json library="Jackson"/>
                </marshal>
                
                <log message="Radiology Bundle for RAD-1 and RAD-2 transactions : ${body}" />
                
            </when>
        </choice>
    </route>
</routes>
